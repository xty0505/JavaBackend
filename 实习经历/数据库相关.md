## 数据库更新操作恢复

### 问题描述

和上游业务联调测试时出现沟通失误。对方 pre 环境在开发没能部署，讨论后采用 HTTP 接口的形式调用 API，操作失误不小心触发接口文档中生产环境的全量更新接口，导致账户表全量更新。发生后业务没有感知到，等到4个小时后才发现问题。

### 解决方法

#### 结合备份数据和 binlog 重放恢复更新前的数据，并且保持更新后4小时内的变更不丢失。

1. 首先在 binlog 中到更新的日志，并用 mysqlbinlog 工具提取目标 binlog
2. 将更新之前的 binlog 在备份表中重放
3. 将更新之后的 binlog 在备份表中重放
4. 最后将备份表 dump 出来，替换原表，过程可能会短暂导致数据不可用

#### 直接逆向执行 binlog

1. 首先在 binlog 中到更新的日志
2. mysqlbinlog 工具将 binlog 转换为逆向的更新 sql
3. 重放这些 sql，达到回滚的效果

